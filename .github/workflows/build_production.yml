# .github/workflows/build_production.yml
name: Setup Environment Variables for Production Branch
on:
  workflow_call:

jobs:
  ######################## Setup Job ########################
  setup:
    runs-on: [self-hosted, frontend_pencilly_us]
    steps:

      - name: all docker clean up
        run: |
          echo "::group::All Docker Clean Up"
          docker container prune --force --filter "until=24h"
          # Remove dangling images only
          docker image prune --force --filter "dangling=true"

          # Remove unused networks (safe - only removes networks with no containers)
          docker network prune --force

          # Option A (Conservative): Only prune explicitly labeled volumes
          docker volume prune --force --filter "label=prune=true"
          echo " this is to ensure no old docker images are present before building new ones!"

      - name: Build Docker Image Production
        run: |
          echo "::group::Building Docker Image"
      - name: Build Docker Image Production
        run: |
          set -e
          echo "::group::Building Docker Image"
          docker compose --env-file production/.env.production -f production/docker/production/docker-compose.yml down || true
          echo "this process is done"
          docker compose --env-file production/.env.production -f production/docker/production/docker-compose.yml up --build -d
          echo "::endgroup::"
